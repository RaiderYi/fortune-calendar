# å‘½è¿æ—¥å†ç”¨æˆ·ä½“ç³»æ–¹æ¡ˆ V2
## é‚®ç®±æ³¨å†Œ + é‚€è¯·æœºåˆ¶ + æ™ºèƒ½åŒæ­¥

**ç‰ˆæœ¬**: v2.0  
**æ›´æ–°æ—¥æœŸ**: 2026-02-11  
**æ ¸å¿ƒè°ƒæ•´**:
- ç™»å½•æ–¹å¼ï¼šä»…é‚®ç®±+å¯†ç æ³¨å†Œ
- æ–°å¢ï¼šé‚€è¯·è¿”åˆ©æœºåˆ¶
- ç§»é™¤ï¼šç§¯åˆ†å•†åŸï¼ˆä¿ç•™æˆå°±å¾½ç« ï¼‰
- åŒæ­¥ç­–ç•¥ï¼šæ™ºèƒ½å¢é‡åŒæ­¥

---

## ä¸€ã€ç™»å½•ä½“ç³»è®¾è®¡

### 1.1 æ³¨å†Œ/ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     é‚®ç®±æ³¨å†Œæµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ è¾“å…¥é‚®ç®±  â”‚ â†’ â”‚ å‘é€éªŒè¯ç  â”‚ â†’ â”‚ è®¾ç½®å¯†ç   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚       â”‚               â”‚               â”‚                    â”‚
â”‚       â–¼               â–¼               â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚           æ¨èï¼šå¡«å†™é‚€è¯·ç               â”‚               â”‚
â”‚  â”‚  "æœ‰é‚€è¯·ç ï¼Ÿå¡«å†™å¯è·å¾—é¢å¤–å¥–åŠ±"         â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                         â”‚                                  â”‚
â”‚                         â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚        ğŸ‰ æ³¨å†ŒæˆåŠŸï¼é¢†å–å¥–åŠ±            â”‚               â”‚
â”‚  â”‚  â€¢ æ–°ç”¨æˆ·ç¤¼åŒ…ï¼šAIæ¬¡æ•°+10ï¼Œé«˜çº§æ¨¡æ¿è§£é”  â”‚               â”‚
â”‚  â”‚  â€¢ å¦‚æœ‰é‚€è¯·ç ï¼šåŒæ–¹å„å¾—+5æ¬¡AIå’¨è¯¢       â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ç™»å½•æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | å®ç°éš¾åº¦ | ç”¨æˆ·ä½“éªŒ | æ•°æ®å®‰å…¨ | é‡‡ç”¨æƒ…å†µ |
|------|---------|---------|---------|----------|
| é‚®ç®±+å¯†ç  | ä½ | ä¸­ | é«˜ | âœ… **é‡‡ç”¨** |
| é‚®ç®±+éªŒè¯ç  | ä¸­ | é«˜ | é«˜ | âŒ éœ€é‚®ä»¶æœåŠ¡ |
| å¾®ä¿¡æ‰«ç  | é«˜ | é«˜ | ä¸­ | âŒ æ— æ¥å£ |
| æ‰‹æœºå· | é«˜ | é«˜ | ä¸­ | âŒ æ— æ¥å£ |

### 1.3 é‚®ç®±æ³¨å†Œå®ç°

```typescript
// æ³¨å†Œæµç¨‹
interface RegisterFlow {
  // æ­¥éª¤1: æäº¤é‚®ç®±
  submitEmail(email: string): Promise<{
    available: boolean;
    emailValid: boolean;
  }>;
  
  // æ­¥éª¤2: å‘é€éªŒè¯ç ï¼ˆä½¿ç”¨ Resend/SendGridï¼‰
  sendVerificationCode(email: string): Promise<{
    sent: boolean;
    cooldown: number; // å†·å´æ—¶é—´ç§’
  }>;
  
  // æ­¥éª¤3: éªŒè¯é‚®ç®±å¹¶æ³¨å†Œ
  verifyAndRegister(
    email: string,
    code: string,
    password: string,
    inviteCode?: string
  ): Promise<{
    success: boolean;
    user: User;
    rewards: Reward[];
  }>;
}

// ç™»å½•æµç¨‹
interface LoginFlow {
  // é‚®ç®±+å¯†ç ç™»å½•
  loginWithPassword(
    email: string,
    password: string
  ): Promise<{
    success: boolean;
    token: string;
    user: User;
  }>;
  
  // è®°ä½æˆ‘ï¼ˆ30å¤©ï¼‰
  rememberMe: boolean;
}
```

---

## äºŒã€é‚€è¯·æœºåˆ¶è®¾è®¡

### 2.1 é‚€è¯·ä½“ç³»æ¶æ„

```
é‚€è¯·äºº (Inviter)                    è¢«é‚€è¯·äºº (Invitee)
     â”‚                                    â”‚
     â”‚  ç”Ÿæˆä¸“å±é‚€è¯·ç /é“¾æ¥               â”‚
     â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‚€è¯·ç A  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æ³¨å†Œå¡«å†™ â”‚
â”‚ é“¾æ¥åˆ†äº« â”‚                       â”‚ é‚€è¯·ç A  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                    â”‚
     â”‚         åŒæ–¹è·å¾—å¥–åŠ±               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ +5æ¬¡AI   â”‚                       â”‚ +5æ¬¡AI   â”‚
â”‚ +1ä¸ªæ¨¡æ¿ â”‚                       â”‚ +1ä¸ªæ¨¡æ¿ â”‚
â”‚ +ç§°å·    â”‚                       â”‚ +ç§°å·    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 é‚€è¯·å¥–åŠ±é˜¶æ¢¯

| é‚€è¯·äººæ•° | é‚€è¯·äººå¥–åŠ± | è¢«é‚€è¯·äººå¥–åŠ± | ç§°å· |
|----------|-----------|-------------|------|
| **æˆåŠŸé‚€è¯·1äºº** | AIæ¬¡æ•°+5/æ—¥<br>è§£é”ã€Œå¼•è·¯äººã€æ¨¡æ¿ | AIæ¬¡æ•°+5/æ—¥<br>è§£é”ã€Œå¹¸è¿æ˜Ÿã€æ¨¡æ¿ | å¼•è·¯äºº |
| **æˆåŠŸé‚€è¯·3äºº** | å…¨éƒ¨æ¨¡æ¿è§£é”<br>æŠ½ç­¾æ¬¡æ•°+5/æ—¥ | åŸºç¡€å¥–åŠ± | å¬é›†è€… |
| **æˆåŠŸé‚€è¯·5äºº** | AIæ— é™æ¬¡æ•°<br>ã€Œå®—å¸ˆã€æ ‡è¯† | åŸºç¡€å¥–åŠ± | å‘½è¿å®—å¸ˆ |
| **æˆåŠŸé‚€è¯·10äºº** | ç»ˆèº«è‡³å°Šä¼šå‘˜<br>å®ä½“å‘¨è¾¹èµ„æ ¼ | åŸºç¡€å¥–åŠ± | å‘½è¿ç¼”é€ è€… |

### 2.3 é‚€è¯·ç æœºåˆ¶

```typescript
// é‚€è¯·ç ç³»ç»Ÿ
interface InviteSystem {
  // ç”Ÿæˆé‚€è¯·ç ï¼ˆç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨åˆ†é…ï¼‰
  generateInviteCode(userId: string): string;
  // æ ¼å¼: FC-XXXXXX (å¦‚ FC-A3F9K2)
  
  // éªŒè¯é‚€è¯·ç 
  validateInviteCode(code: string): Promise<{
    valid: boolean;
    inviterId?: string;
    inviterName?: string;
  }>;
  
  // è®°å½•é‚€è¯·å…³ç³»
  recordInvite(inviterId: string, inviteeId: string): Promise<void>;
  
  // å‘æ”¾å¥–åŠ±
  grantInviteRewards(inviterId: string, inviteeId: string): Promise<{
    inviterRewards: Reward[];
    inviteeRewards: Reward[];
  }>;
}

// æ•°æ®æ¨¡å‹
interface InviteRecord {
  id: string;
  inviterId: string;      // é‚€è¯·äºº
  inviteeId: string;      // è¢«é‚€è¯·äºº
  inviteCode: string;     // ä½¿ç”¨çš„é‚€è¯·ç 
  status: 'pending' | 'completed' | 'rewarded';
  createdAt: string;
  completedAt?: string;   // è¢«é‚€è¯·äººå®Œæˆæ³¨å†Œæ—¶é—´
  rewardedAt?: string;    // å¥–åŠ±å‘æ”¾æ—¶é—´
}

interface UserInviteStats {
  userId: string;
  totalInvites: number;           // æ€»é‚€è¯·æ•°
  successfulInvites: number;      // æˆåŠŸæ³¨å†Œæ•°
  rewardsEarned: Reward[];        // å·²è·å¾—å¥–åŠ±
  inviteCode: string;             // å½“å‰é‚€è¯·ç 
  inviteLink: string;             // é‚€è¯·é“¾æ¥
}
```

### 2.4 é‚€è¯·é¡µé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           é‚€è¯·å¥½å‹ï¼Œå…±äº«å‘½è¿             â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚     [QR Code]                   â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚     æ‰«ç ç«‹å³åŠ å…¥                â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  æ‚¨çš„ä¸“å±é‚€è¯·ç ï¼š                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FC-A3F9K2              [å¤åˆ¶]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  [åˆ†äº«åˆ°å¾®ä¿¡] [å¤åˆ¶é“¾æ¥] [é‚®ä»¶é‚€è¯·]     â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é‚€è¯·è®°å½• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                         â”‚
â”‚  å·²æˆåŠŸé‚€è¯·ï¼š3äºº                        â”‚
â”‚                                         â”‚
â”‚  â”œâ”€ ç”¨æˆ·Aï¼ˆ2026-02-10ï¼‰âœ“ å¥–åŠ±å·²å‘æ”¾    â”‚
â”‚  â”œâ”€ ç”¨æˆ·Bï¼ˆ2026-02-09ï¼‰âœ“ å¥–åŠ±å·²å‘æ”¾    â”‚
â”‚  â””â”€ ç”¨æˆ·Cï¼ˆ2026-02-08ï¼‰â³ æ³¨å†Œä¸­       â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ‚¨çš„å¥–åŠ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚                                         â”‚
â”‚  âœ… AIå’¨è¯¢ +5æ¬¡/æ—¥                      â”‚
â”‚  âœ… è§£é”ã€Œå¼•è·¯äººã€ä¸“å±æ¨¡æ¿              â”‚
â”‚  ğŸ¯ å†é‚€è¯·2äººè§£é”å…¨éƒ¨æ¨¡æ¿               â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ•°æ®åŒæ­¥ç­–ç•¥ï¼ˆç»¼åˆæ–¹æ¡ˆï¼‰

### 3.1 æ™ºèƒ½åŒæ­¥æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ™ºèƒ½åŒæ­¥å†³ç­–å¼•æ“                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   æœ¬åœ°å˜æ›´ â”€â”€â”¬â”€â”€â–º å®æ—¶åŒæ­¥é˜Ÿåˆ— â”€â”€â–º å³æ—¶åŒæ­¥ï¼ˆå…³é”®æ•°æ®ï¼‰      â”‚
â”‚             â”‚                                               â”‚
â”‚             â””â”€â”€â–º å»¶è¿ŸåŒæ­¥é˜Ÿåˆ— â”€â”€â–º å®šæ—¶æ‰¹é‡åŒæ­¥ï¼ˆæ™®é€šæ•°æ®ï¼‰   â”‚
â”‚                                                             â”‚
â”‚   è§¦å‘æ¡ä»¶ï¼š                                                â”‚
â”‚   â€¢ å…³é”®æ•°æ®ï¼ˆæ¡£æ¡ˆã€è®¾ç½®ï¼‰â†’ å®æ—¶åŒæ­¥                        â”‚
â”‚   â€¢ å†å²è®°å½• â†’ å¢é‡åŒæ­¥ï¼ˆæ¯5æ¡æˆ–5åˆ†é’Ÿï¼‰                     â”‚
â”‚   â€¢ å¤§å®¹é‡æ•°æ®ï¼ˆå›¾ç‰‡ï¼‰â†’ æ‰‹åŠ¨è§¦å‘/WiFiæ—¶åŒæ­¥                 â”‚
â”‚                                                             â”‚
â”‚   å†²çªè§£å†³ï¼š                                                â”‚
â”‚   â€¢ æ—¶é—´æˆ³ä¼˜å…ˆï¼ˆé»˜è®¤ï¼‰                                      â”‚
â”‚   â€¢ æ•°æ®ç‰ˆæœ¬å·ï¼ˆå¤æ‚åœºæ™¯ï¼‰                                  â”‚
â”‚   â€¢ ç”¨æˆ·é€‰æ‹©ï¼ˆæœ€åæ‰‹æ®µï¼‰                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 åŒæ­¥ç­–ç•¥çŸ©é˜µ

| æ•°æ®ç±»å‹ | åŒæ­¥é¢‘ç‡ | å†²çªç­–ç•¥ | ç¦»çº¿æ”¯æŒ |
|----------|---------|---------|----------|
| **ç”¨æˆ·æ¡£æ¡ˆ** | å®æ—¶ | æ—¶é—´æˆ³ä¼˜å…ˆ | æœ¬åœ°ç¼“å­˜ï¼Œä¸Šçº¿ååŒæ­¥ |
| **å…«å­—ä¿¡æ¯** | å®æ—¶ | æ—¶é—´æˆ³ä¼˜å…ˆ | æœ¬åœ°ç¼“å­˜ |
| **è®¾ç½®åå¥½** | å®æ—¶ | æ—¶é—´æˆ³ä¼˜å…ˆ | æœ¬åœ°ç¼“å­˜ |
| **å†å²è®°å½•** | å¢é‡ï¼ˆ5æ¡/5åˆ†é’Ÿï¼‰ | åˆå¹¶å»é‡ | IndexedDBå­˜å‚¨ |
| **AIå¯¹è¯** | æ‰‹åŠ¨/æ¯æ—¥ | æ—¶é—´æˆ³ä¼˜å…ˆ | æœ¬åœ°7å¤©æ»šåŠ¨å­˜å‚¨ |
| **æŠ½ç­¾è®°å½•** | å®æ—¶ | æ—¶é—´æˆ³ä¼˜å…ˆ | æœ¬åœ°30æ¡å­˜å‚¨ |
| **æ—¥ç­¾æ”¶è—** | å®æ—¶ | æ—¶é—´æˆ³ä¼˜å…ˆ | æœ¬åœ°ç¼“å­˜ |
| **æˆå°±è¿›åº¦** | å®æ—¶ | äº‘ç«¯ä¸ºå‡† | æœ¬åœ°ç¼“å­˜ |

### 3.3 åŒæ­¥ç®¡ç†å™¨å®ç°

```typescript
// æ™ºèƒ½åŒæ­¥ç®¡ç†å™¨
class SmartSyncManager {
  private syncQueue: SyncTask[] = [];
  private isOnline: boolean = navigator.onLine;
  private syncInterval: number = 5 * 60 * 1000; // 5åˆ†é’Ÿ
  
  constructor() {
    this.initOnlineListener();
    this.startPeriodicSync();
  }
  
  // æ•°æ®å˜æ›´æ—¶è°ƒç”¨
  async onDataChange(type: DataType, data: any) {
    // 1. ä¿å­˜åˆ°æœ¬åœ°
    await this.saveToLocal(type, data);
    
    // 2. åˆ¤æ–­æ˜¯å¦ç™»å½•
    if (!this.isLoggedIn()) return;
    
    // 3. æ ¹æ®æ•°æ®ç±»å‹å†³å®šåŒæ­¥ç­–ç•¥
    if (this.isCriticalData(type)) {
      // å…³é”®æ•°æ®ï¼šç«‹å³åŒæ­¥
      await this.syncImmediately(type, data);
    } else {
      // æ™®é€šæ•°æ®ï¼šåŠ å…¥é˜Ÿåˆ—
      this.enqueueSync(type, data);
    }
  }
  
  // å…³é”®æ•°æ®åˆ¤æ–­
  private isCriticalData(type: DataType): boolean {
    return ['profile', 'settings', 'bazi'].includes(type);
  }
  
  // ç«‹å³åŒæ­¥
  private async syncImmediately(type: DataType, data: any) {
    try {
      await this.uploadToCloud(type, data);
      this.emit('sync:success', { type, timestamp: Date.now() });
    } catch (error) {
      // å¤±è´¥åˆ™åŠ å…¥é˜Ÿåˆ—ç¨åé‡è¯•
      this.enqueueSync(type, data);
      this.emit('sync:retry', { type, error });
    }
  }
  
  // åŠ å…¥åŒæ­¥é˜Ÿåˆ—
  private enqueueSync(type: DataType, data: any) {
    const existingIndex = this.syncQueue.findIndex(
      task => task.type === type && task.id === data.id
    );
    
    if (existingIndex >= 0) {
      // æ›´æ–°å·²æœ‰ä»»åŠ¡
      this.syncQueue[existingIndex].data = data;
      this.syncQueue[existingIndex].timestamp = Date.now();
    } else {
      // æ·»åŠ æ–°ä»»åŠ¡
      this.syncQueue.push({
        type,
        id: data.id,
        data,
        timestamp: Date.now(),
        retryCount: 0
      });
    }
  }
  
  // å®šæ—¶æ‰¹é‡åŒæ­¥
  private async startPeriodicSync() {
    setInterval(async () => {
      if (!this.isOnline || !this.isLoggedIn()) return;
      if (this.syncQueue.length === 0) return;
      
      // æ‰¹é‡ä¸Šä¼ 
      const batch = this.syncQueue.splice(0, 10); // æ¯æ¬¡æœ€å¤š10æ¡
      try {
        await this.uploadBatch(batch);
        this.emit('sync:batch:success', { count: batch.length });
      } catch (error) {
        // å¤±è´¥åˆ™æ”¾å›é˜Ÿåˆ—
        batch.forEach(task => {
          task.retryCount++;
          if (task.retryCount < 3) {
            this.syncQueue.unshift(task);
          }
        });
      }
    }, this.syncInterval);
  }
  
  // ä¸Šçº¿æ—¶åŒæ­¥
  private initOnlineListener() {
    window.addEventListener('online', () => {
      this.isOnline = true;
      this.syncAllPending();
    });
    
    window.addEventListener('offline', () => {
      this.isOnline = false;
    });
  }
  
  // ç”¨æˆ·ç™»å½•æ—¶è§¦å‘å…¨é‡åŒæ­¥
  async onUserLogin(userId: string) {
    // 1. ä¸‹è½½äº‘ç«¯æ•°æ®
    const cloudData = await this.downloadFromCloud(userId);
    
    // 2. è·å–æœ¬åœ°æ•°æ®
    const localData = await this.getAllLocalData();
    
    // 3. æ™ºèƒ½åˆå¹¶
    const merged = this.smartMerge(localData, cloudData);
    
    // 4. ä¿å­˜å¹¶ä¸Šä¼ 
    await this.saveToLocalBulk(merged);
    await this.uploadToCloudBulk(merged);
    
    return merged;
  }
  
  // æ™ºèƒ½åˆå¹¶ç®—æ³•
  private smartMerge(local: Data, cloud: Data): Data {
    const merged = { ...cloud };
    
    for (const key in local) {
      const localItem = local[key];
      const cloudItem = cloud[key];
      
      if (!cloudItem) {
        // äº‘ç«¯æ²¡æœ‰ï¼Œä½¿ç”¨æœ¬åœ°
        merged[key] = localItem;
      } else if (localItem.updatedAt > cloudItem.updatedAt) {
        // æœ¬åœ°æ›´æ–°ï¼Œè¦†ç›–äº‘ç«¯
        merged[key] = localItem;
      }
      // å¦åˆ™ä¿ç•™äº‘ç«¯
    }
    
    return merged;
  }
}
```

### 3.4 å†²çªè§£å†³UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ•°æ®åŒæ­¥å†²çª                   â”‚
â”‚                                         â”‚
â”‚  æ£€æµ‹åˆ°æœ¬åœ°æ•°æ®ä¸äº‘ç«¯æ•°æ®ä¸ä¸€è‡´          â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ“± æœ¬åœ°æ•°æ®                    â”‚   â”‚
â”‚  â”‚  æœ€åæ›´æ–°ï¼š2026-02-11 10:30     â”‚   â”‚
â”‚  â”‚  [é¢„è§ˆå†…å®¹...]                  â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚     [ä½¿ç”¨æœ¬åœ°]                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚              VS                         â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â˜ï¸ äº‘ç«¯æ•°æ®                    â”‚   â”‚
â”‚  â”‚  æœ€åæ›´æ–°ï¼š2026-02-11 09:15     â”‚   â”‚
â”‚  â”‚  [é¢„è§ˆå†…å®¹...]                  â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚     [ä½¿ç”¨äº‘ç«¯]                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚        [æ™ºèƒ½åˆå¹¶ï¼ˆæ¨èï¼‰]               â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€ç”¨æˆ·æ¿€åŠ±ä½“ç³»ï¼ˆç²¾ç®€ç‰ˆï¼‰

### 4.1 ç™»å½•å¥–åŠ±ï¼ˆæ— ç§¯åˆ†ï¼‰

| è§¦å‘æ¡ä»¶ | å¥–åŠ±å†…å®¹ | æœ‰æ•ˆæœŸ |
|----------|---------|--------|
| **é¦–æ¬¡ç™»å½•** | â€¢ AIæ¬¡æ•° 5â†’15æ¬¡/æ—¥<br>â€¢ è§£é”å…¨éƒ¨åŸºç¡€æ¨¡æ¿<br>â€¢ å†å²è®°å½•æ°¸ä¹…ä¿å­˜ | æ°¸ä¹… |
| **è¿ç»­3å¤©ç™»å½•** | â€¢ AIæ¬¡æ•°+5ï¼ˆä¸´æ—¶ï¼‰<br>â€¢ è§£é”ã€Œæœˆè¿å…ˆçŸ¥ã€ä¸»é¢˜ | 7å¤© |
| **è¿ç»­7å¤©ç™»å½•** | â€¢ æŠ½ç­¾æ¬¡æ•°+3ï¼ˆä¸´æ—¶ï¼‰<br>â€¢ äº‘å¤‡ä»½è‡ªåŠ¨å¼€å¯ | æ°¸ä¹… |
| **è¿ç»­30å¤©ç™»å½•** | â€¢ ã€Œå‘½è¿å®ˆæŠ¤è€…ã€ç§°å·<br>â€¢ ä¸“å±å®¢æœé€šé“ | æ°¸ä¹… |

### 4.2 é‚€è¯·å¥–åŠ±ï¼ˆæ ¸å¿ƒæ¿€åŠ±ï¼‰

```typescript
// é‚€è¯·å¥–åŠ±ç³»ç»Ÿï¼ˆæ— ç§¯åˆ†ï¼Œç›´æ¥åŠŸèƒ½å¥–åŠ±ï¼‰
interface InviteRewardSystem {
  // è¢«é‚€è¯·äººæ³¨å†ŒæˆåŠŸæ—¶è§¦å‘
  onInviteSuccess(inviterId: string, inviteeId: string) {
    // åŒæ–¹å³æ—¶å¥–åŠ±
    this.grantInstantRewards(inviterId, inviteeId);
    
    // æ›´æ–°é‚€è¯·ç»Ÿè®¡
    this.updateInviteStats(inviterId);
    
    // æ£€æŸ¥é‡Œç¨‹ç¢‘å¥–åŠ±
    this.checkMilestoneRewards(inviterId);
  }
  
  // å³æ—¶å¥–åŠ±
  private grantInstantRewards(inviterId: string, inviteeId: string) {
    // é‚€è¯·äººå¥–åŠ±
    this.addToUser(inviterId, {
      aiQuotaBonus: 5,           // +5æ¬¡AI/æ—¥ï¼ˆ30å¤©ï¼‰
      unlockTemplate: 'inviter',  // è§£é”ã€Œå¼•è·¯äººã€æ¨¡æ¿
      badge: 'guide'              // ã€Œå¼•è·¯äººã€å¾½ç« 
    });
    
    // è¢«é‚€è¯·äººå¥–åŠ±
    this.addToUser(inviteeId, {
      aiQuotaBonus: 5,           // +5æ¬¡AI/æ—¥ï¼ˆ30å¤©ï¼‰
      unlockTemplate: 'lucky',    // è§£é”ã€Œå¹¸è¿æ˜Ÿã€æ¨¡æ¿
      badge: 'newcomer'           // ã€Œæ–°æ˜Ÿã€å¾½ç« 
    });
  }
  
  // é‡Œç¨‹ç¢‘å¥–åŠ±
  private checkMilestoneRewards(userId: string) {
    const count = this.getSuccessfulInvites(userId);
    
    const milestones = [
      { count: 3, reward: { unlockAllTemplates: true, drawQuotaBonus: 3 } },
      { count: 5, reward: { aiUnlimited: true, title: 'master' } },
      { count: 10, reward: { premiumForever: true, physicalGift: true, title: 'creator' } }
    ];
    
    const milestone = milestones.find(m => m.count === count);
    if (milestone) {
      this.grantMilestoneReward(userId, milestone.reward);
      this.showMilestoneCelebration(userId, count);
    }
  }
}
```

### 4.3 å¥–åŠ±å±•ç¤ºè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ‰ æ­å–œè·å¾—é‚€è¯·å¥–åŠ±ï¼            â”‚
â”‚                                         â”‚
â”‚  æ‚¨æˆåŠŸé‚€è¯· [ç”¨æˆ·å] åŠ å…¥å‘½è¿æ—¥å†        â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚    [å¥–åŠ±åŠ¨ç”»]                   â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚    +5æ¬¡ AIå’¨è¯¢/æ—¥               â”‚   â”‚
â”‚  â”‚    æœ‰æ•ˆæœŸï¼š30å¤©                 â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  å·²è§£é”ï¼šã€Œå¼•è·¯äººã€ä¸“å±æ¨¡æ¿             â”‚
â”‚                                         â”‚
â”‚  [æŸ¥çœ‹æˆ‘çš„é‚€è¯·è®°å½•]  [ç»§ç»­é‚€è¯·]         â”‚
â”‚                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”‚
â”‚  ğŸ¯ å†é‚€è¯· 2 äººå³å¯è§£é”å…¨éƒ¨æ¨¡æ¿ï¼       â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€æŠ€æœ¯å®ç°è·¯çº¿

### 5.1 Phase 1: é‚®ç®±è®¤è¯ç³»ç»Ÿï¼ˆ1å‘¨ï¼‰

```
Day 1-2: åç«¯API
â”œâ”€â”€ é‚®ç®±æ³¨å†Œ/ç™»å½• API
â”œâ”€â”€ JWT Token ä½“ç³»
â”œâ”€â”€ éªŒè¯ç é‚®ä»¶æœåŠ¡ï¼ˆResendï¼‰
â””â”€â”€ å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆbcryptï¼‰

Day 3-4: å‰ç«¯å®ç°
â”œâ”€â”€ æ³¨å†Œ/ç™»å½•é¡µé¢
â”œâ”€â”€ è¡¨å•éªŒè¯
â”œâ”€â”€ çŠ¶æ€ç®¡ç†ï¼ˆAuthContextï¼‰
â””â”€â”€ é”™è¯¯å¤„ç†

Day 5: è”è°ƒæµ‹è¯•
â”œâ”€â”€ APIå¯¹æ¥
â”œâ”€â”€ æµç¨‹æµ‹è¯•
â””â”€â”€ å®‰å…¨æµ‹è¯•
```

### 5.2 Phase 2: é‚€è¯·ç³»ç»Ÿï¼ˆ1å‘¨ï¼‰

```
Day 1-2: é‚€è¯·ç ç³»ç»Ÿ
â”œâ”€â”€ é‚€è¯·ç ç”Ÿæˆç®—æ³•
â”œâ”€â”€ é‚€è¯·å…³ç³»å­˜å‚¨
â””â”€â”€ é‚€è¯·ç»Ÿè®¡API

Day 3-4: å¥–åŠ±å‘æ”¾
â”œâ”€â”€ å¥–åŠ±è§„åˆ™å¼•æ“
â”œâ”€â”€ é‚€è¯·æˆåŠŸå›è°ƒ
â””â”€â”€ å¥–åŠ±è®°å½•å­˜å‚¨

Day 5: é‚€è¯·é¡µé¢
â”œâ”€â”€ é‚€è¯·ç å±•ç¤º
â”œâ”€â”€ QR Codeç”Ÿæˆ
â”œâ”€â”€ åˆ†äº«åŠŸèƒ½
â””â”€â”€ é‚€è¯·è®°å½•åˆ—è¡¨
```

### 5.3 Phase 3: æ•°æ®åŒæ­¥ï¼ˆ1.5å‘¨ï¼‰

```
Day 1-3: åŒæ­¥ç®¡ç†å™¨
â”œâ”€â”€ æœ¬åœ°å­˜å‚¨å°è£…
â”œâ”€â”€ åŒæ­¥é˜Ÿåˆ—å®ç°
â”œâ”€â”€ å†²çªæ£€æµ‹ç®—æ³•
â””â”€â”€ åˆå¹¶ç­–ç•¥

Day 4-5: äº‘ç«¯å­˜å‚¨
â”œâ”€â”€ Vercel KV å°è£…
â”œâ”€â”€ å¢é‡åŒæ­¥API
â”œâ”€â”€ æ‰¹é‡ä¸Šä¼ /ä¸‹è½½
â””â”€â”€ ç‰ˆæœ¬æ§åˆ¶

Day 6-7: è”è°ƒä¼˜åŒ–
â”œâ”€â”€ å¤šç«¯åŒæ­¥æµ‹è¯•
â”œâ”€â”€ ç¦»çº¿åœºæ™¯æµ‹è¯•
â”œâ”€â”€ å†²çªè§£å†³UI
â””â”€â”€ æ€§èƒ½ä¼˜åŒ–
```

### 5.4 Phase 4: åŠŸèƒ½å¼€æ”¾ï¼ˆ1å‘¨ï¼‰

```
Day 1-2: ç§»é™¤ç™»å½•é™åˆ¶
â”œâ”€â”€ è¯†åˆ«æ‰€æœ‰é™åˆ¶ç‚¹
â”œâ”€â”€ ä¿®æ”¹æƒé™æ£€æŸ¥
â””â”€â”€ æ¸¸å®¢æ¨¡å¼æµ‹è¯•

Day 3-4: æ¬¡æ•°é™åˆ¶
â”œâ”€â”€ AIå’¨è¯¢æ¬¡æ•°æ§åˆ¶
â”œâ”€â”€ æŠ½ç­¾æ¬¡æ•°æ§åˆ¶
â”œâ”€â”€ æ¨¡æ¿æƒé™æ§åˆ¶
â””â”€â”€ æç¤ºUIè®¾è®¡

Day 5: ç™»å½•å¼•å¯¼
â”œâ”€â”€ è‡ªç„¶å¼•å¯¼ç‚¹æ¤å…¥
â”œâ”€â”€ å¥–åŠ±é¢„è§ˆå¼¹çª—
â””â”€â”€ A/Bæµ‹è¯•å‡†å¤‡
```

---

## å…­ã€å…³é”®æ¥å£å®šä¹‰

### 6.1 è®¤è¯æ¥å£

```typescript
// POST /api/auth/register
interface RegisterRequest {
  email: string;
  password: string;
  verificationCode: string;
  inviteCode?: string;      // å¯é€‰é‚€è¯·ç 
}

interface RegisterResponse {
  success: boolean;
  user: {
    id: string;
    email: string;
    createdAt: string;
  };
  token: string;
  rewards: {
    type: string;
    description: string;
  }[];
  inviteReward?: {          // å¦‚æœ‰é‚€è¯·ç 
    inviterName: string;
    rewardDescription: string;
  };
}

// POST /api/auth/login
interface LoginRequest {
  email: string;
  password: string;
  rememberMe: boolean;
}

interface LoginResponse {
  success: boolean;
  user: User;
  token: string;
  refreshToken: string;
  pendingSync?: boolean;    // æ˜¯å¦éœ€è¦æ•°æ®åŒæ­¥
}
```

### 6.2 é‚€è¯·æ¥å£

```typescript
// GET /api/invite/info
interface InviteInfoResponse {
  inviteCode: string;
  inviteLink: string;
  totalInvites: number;
  successfulInvites: number;
  currentRewards: {
    aiQuotaBonus: number;
    unlockedTemplates: string[];
    badges: string[];
  };
  nextMilestone?: {
    target: number;
    current: number;
    reward: string;
  };
}

// POST /api/invite/validate
interface ValidateInviteRequest {
  code: string;
}

interface ValidateInviteResponse {
  valid: boolean;
  inviterName?: string;
}
```

### 6.3 åŒæ­¥æ¥å£

```typescript
// POST /api/sync/upload
interface SyncUploadRequest {
  dataType: 'profile' | 'history' | 'settings' | 'achievements';
  data: any;
  checksum: string;
  timestamp: number;
}

// GET /api/sync/download?since=timestamp
interface SyncDownloadResponse {
  profile?: UserProfile;
  history?: FortuneRecord[];
  settings?: UserSettings;
  achievements?: Achievement[];
  deletedIds?: string[];    // å·²åˆ é™¤çš„è®°å½•ID
}

// POST /api/sync/resolve-conflict
interface ResolveConflictRequest {
  conflicts: Array<{
    type: string;
    localVersion: any;
    cloudVersion: any;
    resolution: 'local' | 'cloud' | 'merge';
  }>;
}
```

---

## ä¸ƒã€å®‰å…¨ä¸éšç§

### 7.1 å®‰å…¨æªæ–½

| æªæ–½ | å®ç°æ–¹å¼ |
|------|---------|
| å¯†ç åŠ å¯† | bcrypt, cost=12 |
| JWTç­¾å | HS256, å¯†é’¥è½®æ¢ |
| Tokenæœ‰æ•ˆæœŸ | Access: 24h, Refresh: 30d |
| éªŒè¯ç  | 6ä½æ•°å­—, 5åˆ†é’Ÿæœ‰æ•ˆ, 3æ¬¡é”™è¯¯é”å®š |
| ç™»å½•é¢‘ç‡ | åŒä¸€IP 5åˆ†é’Ÿå†…æœ€å¤š5æ¬¡ |
| å¯†ç é‡ç½® | é‚®ä»¶é“¾æ¥, 24å°æ—¶æœ‰æ•ˆ |

### 7.2 éšç§ä¿æŠ¤

- é‚®ç®±ä»…ç”¨äºç™»å½•ï¼Œä¸å‘ç¬¬ä¸‰æ–¹é€éœ²
- ç”¨æˆ·æ•°æ®åŠ å¯†å­˜å‚¨
- æ”¯æŒè´¦å·æ³¨é”€ï¼ˆGDPRåˆè§„ï¼‰
- æ˜ç¡®å‘ŠçŸ¥æ•°æ®åŒæ­¥èŒƒå›´

---

**æ–‡æ¡£ç»“æŸ**

*æœ¬æ–¹æ¡ˆåŸºäºé‚®ç®±æ³¨å†Œ + é‚€è¯·æœºåˆ¶ï¼Œå·²å»é™¤ç§¯åˆ†å•†åŸï¼Œä¿ç•™æˆå°±å¾½ç« ä½“ç³»ã€‚*
