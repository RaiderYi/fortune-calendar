# 命运日历用户体系优化方案
## 功能无门槛 · 登录有惊喜

**版本**: v1.0  
**设计日期**: 2026-02-11  
**核心原则**: 不登录享完整功能，登录用户获额外奖励

---

## 目录

1. [设计原则与目标](#一设计原则与目标)
2. [功能分层架构](#二功能分层架构)
3. [数据存储策略](#三数据存储策略)
4. [用户激励体系](#四用户激励体系)
5. [账号关联与迁移](#五账号关联与迁移)
6. [技术实现方案](#六技术实现方案)
7. [UI/UX 设计](#七uiux-设计)
8. [实施路线图](#八实施路线图)

---

## 一、设计原则与目标

### 1.1 核心原则

| 原则 | 说明 |
|------|------|
| **零门槛使用** | 所有核心功能无需登录即可使用，降低用户决策成本 |
| **渐进式引导** | 在用户使用过程中自然引导登录，而非强制拦截 |
| **价值交换** | 登录用户提供额外价值（云同步、奖励、特权），而非功能解锁 |
| **数据自主** | 用户数据默认本地存储，上传云端需明确授权 |
| **无损迁移** | 登录后本地数据可无缝关联到账号 |

### 1.2 业务目标

| 指标 | 现状 | 目标 | 提升幅度 |
|------|------|------|----------|
| 功能使用率 | 60%（需登录） | 95%（无门槛） | +58% |
| 登录转化率 | 15% | 40% | +167% |
| 用户留存率（7日） | 25% | 45% | +80% |
| 用户满意度 | 3.8/5 | 4.5/5 | +18% |

---

## 二、功能分层架构

### 2.1 功能权限矩阵

| 功能模块 | 未登录用户 | 登录用户 | 差异说明 |
|----------|-----------|----------|----------|
| **八字测算** | ✅ 完整使用 | ✅ 完整使用 + 历史云同步 | 登录可多设备同步 |
| **每日运势** | ✅ 完整使用 | ✅ 完整使用 + 推送通知 | 登录可接收每日推送 |
| **AI 咨询** | ✅ 5次/日 | ✅ 20次/日 | 登录额外15次 |
| **抽签** | ✅ 3次/日 | ✅ 10次/日 | 登录额外7次 |
| **日签生成** | ✅ 基础模板 | ✅ 全部模板 + 高清 | 登录解锁高级模板 |
| **十年大运** | ✅ 完整查看 | ✅ 完整查看 + 导出PDF | 登录可导出 |
| **历史记录** | ✅ 本地30天 | ✅ 云端永久 | 登录无限存储 |
| **数据备份** | ❌ | ✅ 自动云备份 | 登录专属 |
| **多设备同步** | ❌ | ✅ 实时同步 | 登录专属 |
| **成就系统** | ✅ 本地记录 | ✅ 云端排名 + 奖励 | 登录可参与排行 |
| **社区功能** | ✅ 只读浏览 | ✅ 发帖/评论/点赞 | 登录可互动 |
| **专属客服** | ❌ | ✅ 优先响应 | 登录专属 |

### 2.2 功能分层图解

```
┌─────────────────────────────────────────────────────────────┐
│                      功能分层金字塔                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│     ┌─────────────┐                                         │
│     │   增值层    │  云同步 · 导出PDF · 专属客服             │
│     │  (登录专属) │                                         │
│     └──────┬──────┘                                         │
│            ▼                                                │
│     ┌─────────────┐                                         │
│     │   增强层    │  次数提升 · 高级模板 · 推送通知          │
│     │ (登录更优)  │                                         │
│     └──────┬──────┘                                         │
│            ▼                                                │
│     ┌─────────────┐                                         │
│     │   基础层    │  八字测算 · 每日运势 · AI咨询 · 抽签     │
│     │ (完全开放)  │  所有人可用，无需登录                    │
│     └─────────────┘                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、数据存储策略

### 3.1 双轨存储架构

```typescript
// 数据存储策略
interface StorageStrategy {
  // 本地存储（所有用户）
  local: {
    userProfile: 'localStorage';      // 用户档案
    fortuneHistory: 'IndexedDB';      // 运势历史（30天）
    settings: 'localStorage';         // 设置偏好
    achievements: 'localStorage';     // 成就数据
  };
  
  // 云端存储（登录用户）
  cloud: {
    userProfile: 'Vercel KV';         // 用户档案备份
    fortuneHistory: 'Vercel KV';      // 永久历史
    syncTimestamp: 'Vercel KV';       // 同步时间戳
    deviceList: 'Vercel KV';          // 设备列表
  };
}
```

### 3.2 数据分类与存储位置

| 数据类型 | 未登录存储 | 登录后存储 | 同步策略 |
|----------|-----------|-----------|----------|
| 用户档案 | localStorage | Vercel KV + localStorage | 实时双向同步 |
| 八字信息 | localStorage | Vercel KV + localStorage | 首次登录上传 |
| 历史记录 | IndexedDB (30天) | Vercel KV (永久) + IndexedDB | 增量同步 |
| 设置偏好 | localStorage | Vercel KV + localStorage | 实时同步 |
| AI对话记录 | IndexedDB (7天) | Vercel KV (永久) | 可选同步 |
| 抽签记录 | IndexedDB (30条) | Vercel KV (永久) | 增量同步 |
| 成就进度 | localStorage | Vercel KV + localStorage | 实时同步 |
| 日签收藏 | IndexedDB | Vercel KV (永久) | 实时同步 |

### 3.3 数据同步机制

```typescript
// 同步管理器
class SyncManager {
  // 判断是否登录
  isLoggedIn(): boolean;
  
  // 本地数据变更时触发
  onLocalChange(key: string, data: any) {
    // 1. 保存到本地
    localStorage.setItem(key, JSON.stringify(data));
    
    // 2. 如果已登录，同步到云端
    if (this.isLoggedIn()) {
      this.syncToCloud(key, data);
    }
  }
  
  // 用户登录时触发
  async onUserLogin(userId: string) {
    // 1. 检查云端是否有数据
    const cloudData = await this.fetchFromCloud(userId);
    
    // 2. 获取本地数据
    const localData = this.getAllLocalData();
    
    // 3. 智能合并（以时间戳为准）
    const merged = this.mergeData(cloudData, localData);
    
    // 4. 保存到本地和云端
    this.saveToLocal(merged);
    await this.syncToCloud(merged);
  }
  
  // 数据合并策略
  mergeData(cloud: Data, local: Data): Data {
    // 以时间戳较新的为准
    // 冲突时提示用户选择
  }
}
```

---

## 四、用户激励体系

### 4.1 登录奖励阶梯

| 登录次数 | 奖励内容 | 价值感知 |
|----------|---------|----------|
| **首次登录** | • 解锁全部日签模板<br>• AI咨询次数提升至20次/日<br>• 赠送「星辰守护者」徽章 | 高价值感入门礼 |
| **连续3天** | • 解锁「时空旅人」主题<br>• 抽签次数+3<br>• 专属运势解读报告 | 培养使用习惯 |
| **连续7天** | • 解锁「命运先知」称号<br>• 云备份永久开启<br>• 专属客服通道 | 建立忠诚度 |
| **连续30天** | • 终身「至尊会员」标识<br>• 所有功能无限次使用<br>• 实体周边抽奖资格 | 超级用户培养 |

### 4.2 功能特权对比

#### AI 咨询次数
```
未登录: █████ (5次/日)
登录后: ████████████████████ (20次/日)

视觉提示: 未登录用户使用后显示
"今日还剩 X 次，登录即可获得 20 次/日"
```

#### 日签模板
```
未登录: 可使用 3 款基础模板
登录后: 解锁 12 款高级模板 + 每月新模板

视觉提示: 高级模板显示 "登录解锁" 徽章
点击后弹出奖励预览
```

#### 历史记录
```
未登录: 本地保存 30 天
登录后: 永久云端存储 + 多设备同步

视觉提示: 接近30天时提示
"您的历史记录将在 X 天后清理，登录永久保存"
```

### 4.3 成就与徽章系统

| 徽章 | 获得条件 | 未登录状态 | 登录后状态 |
|------|---------|-----------|-----------|
| 🌟 初识命运 | 首次查看运势 | 本地记录 | 云端永久 + 积分+10 |
| 🔮 命理学徒 | 连续查看7天 | 本地记录 | 云端永久 + 积分+50 |
| 📿 签灵觉醒 | 首次抽签 | 本地记录 | 云端永久 + 解锁特效 |
| 🌙 月运先知 | 查看月运 | 本地记录 | 云端永久 + 专属主题 |
| ⚡ 能量满格 | 用完AI次数 | 本地记录 | 积分+20 + 次日+5次 |

**积分用途**:
- 兑换日签特效
- 解锁限定主题
- 参与抽奖活动
- 兑换实物周边

---

## 五、账号关联与迁移

### 5.1 登录时机设计

**自然引导点（非强制）**:

| 场景 | 引导文案 | 奖励预览 |
|------|---------|---------|
| 用完AI次数 | "今日次数已用完，登录立即获得20次/日" | 展示解锁后的次数条 |
| 点击高级模板 | "12款精美模板登录即解锁" | 模板预览轮播 |
| 历史即将清理 | "您的记录将在3天后清理，登录永久保存" | 云端存储示意图 |
| 切换设备 | "登录即可在新设备查看所有记录" | 多设备同步动画 |
| 分享日签 | "登录后可生成无水印高清图" | 对比图展示 |
| 连续使用3天 | "恭喜！登录领取连续打卡奖励" | 奖励清单弹窗 |

### 5.2 数据迁移流程

```
用户点击登录
    │
    ├─ 展示「数据关联确认」弹窗
    │   ├─ 显示本地数据摘要
    │   │   • 历史记录: 28条
    │   │   • 抽签记录: 15条
    │   │   • 成就进度: 7/20
    │   └─ 说明登录后这些数据将
    │       • 永久云端保存 ✓
    │       • 多设备同步 ✓
    │       • 永不丢失 ✓
    │
    ├─ 用户完成登录
    │
    └─ 系统自动合并数据
        ├─ 检查云端是否有旧数据
        │   ├─ 无 → 直接上传本地数据
        │   └─ 有 → 智能合并
        │       ├─ 以时间戳为准
        │       └─ 冲突项提示用户
        │
        └─ 合并完成提示
            "成功关联 X 条记录至您的账号"
```

### 5.3 登录方式

| 方式 | 优先级 | 说明 |
|------|--------|------|
| **微信扫码** | P0 | 国内主流，一键登录 |
| **手机号+验证码** | P0 | 普适性强，无需密码 |
| **Apple ID** | P1 | iOS用户友好 |
| **Google** | P2 | 海外用户 |
| **邮箱+密码** | P2 | 传统方式，备选 |

---

## 六、技术实现方案

### 6.1 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (React)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  本地存储层  │  │  用户状态机  │  │  同步管理器  │         │
│  │ localStorage│  │ AuthContext │  │ SyncManager │         │
│  │ IndexedDB   │  │ UserContext │  │ CloudSync   │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                │
│         └────────────────┴────────────────┘                │
│                          │                                  │
└──────────────────────────┼──────────────────────────────────┘
                           │ API / WebSocket
┌──────────────────────────┼──────────────────────────────────┐
│                      后端 (Vercel)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Auth API   │  │  User API   │  │  Sync API   │         │
│  │ /api/auth   │  │ /api/user   │  │ /api/sync   │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                │
│         └────────────────┴────────────────┘                │
│                          │                                  │
│                   ┌──────┴──────┐                          │
│                   │  Vercel KV  │                          │
│                   │ (数据存储)   │                          │
│                   └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 核心数据结构

```typescript
// 用户档案（本地 + 云端）
interface UserProfile {
  id?: string;                    // 登录后分配
  isGuest: boolean;              // 是否游客
  deviceId: string;              // 设备唯一标识
  
  // 基本信息
  name: string;
  birthDate: string;
  birthTime: string;
  birthLocation: string;
  
  // 八字信息
  bazi: {
    year: string;
    month: string;
    day: string;
    hour: string;
    dayMaster: string;
  };
  
  // 设置
  settings: UserSettings;
  
  // 时间戳
  createdAt: string;
  updatedAt: string;
  lastSyncAt?: string;
}

// 登录用户扩展信息
interface LoggedInUser extends UserProfile {
  id: string;
  email?: string;
  phone?: string;
  wechatOpenId?: string;
  appleId?: string;
  
  // 会员状态
  membership: {
    level: 'free' | 'supporter' | 'premium';
    since: string;
    expiresAt?: string;
  };
  
  // 设备管理
  devices: Array<{
    id: string;
    name: string;
    lastActive: string;
  }>;
  
  // 奖励记录
  rewards: Array<{
    type: string;
    grantedAt: string;
    expiresAt?: string;
  }>;
}

// 同步记录
interface SyncRecord {
  userId: string;
  deviceId: string;
  dataType: 'profile' | 'history' | 'settings' | 'achievements';
  version: number;
  checksum: string;
  syncedAt: string;
}
```

### 6.3 API 接口设计

```typescript
// 认证相关
POST /api/auth/send-code          // 发送验证码
POST /api/auth/verify-code        // 验证并登录
POST /api/auth/wechat             // 微信登录
POST /api/auth/apple              // Apple登录
POST /api/auth/logout             // 退出登录
GET  /api/auth/refresh            // 刷新Token

// 用户数据
GET    /api/user/profile          // 获取用户档案
PUT    /api/user/profile          // 更新档案
DELETE /api/user/account          // 注销账号

// 同步接口
POST /api/sync/upload             // 上传本地数据
GET  /api/sync/download           // 下载云端数据
POST /api/sync/merge              // 合并冲突数据
GET  /api/sync/status             // 获取同步状态

// 奖励接口
GET  /api/rewards/available       // 可领取奖励
POST /api/rewards/claim           // 领取奖励
GET  /api/rewards/history         // 奖励历史
```

### 6.4 安全策略

| 安全措施 | 实现方式 |
|----------|---------|
| Token机制 | JWT + Refresh Token，有效期7天 |
| 数据加密 | 敏感字段AES-256加密存储 |
| 传输安全 | 全站HTTPS，HSTS启用 |
| 频率限制 | API限流（100次/分钟） |
| 设备验证 | 新设备登录需验证 |
| 数据隔离 | 用户数据严格隔离，不可越权访问 |

---

## 七、UI/UX 设计

### 7.1 登录入口设计

**方案A: 悬浮胶囊（推荐）**
```
┌─────────────────────────────────────────┐
│                                         │
│  [Logo]  命运日历            [⚙️] [👤]  │  ← 顶部导航
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  👤 游客  ·  点击登录享特权   >  │   │  ← 悬浮胶囊
│  └─────────────────────────────────┘   │     （滚动时缩小为图标）
│                                         │
└─────────────────────────────────────────┘
```

**方案B: 底部提示条**
```
┌─────────────────────────────────────────┐
│                                         │
│         主要功能区域                     │
│                                         │
├─────────────────────────────────────────┤
│  💡 登录后解锁20次AI咨询/日     [登录]  │  ← 底部提示
└─────────────────────────────────────────┘
     （根据使用场景动态变化提示内容）
```

### 7.2 登录弹窗设计

```
┌─────────────────────────────────────────┐
│         开启您的命运之旅                │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │      [微信图标] 微信一键登录      │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  📱 输入手机号                  │   │
│  └─────────────────────────────────┘   │
│                                         │
│     [获取验证码]                       │
│                                         │
│  ─────────── 登录即同意 ───────────    │
│  《用户协议》和《隐私政策》             │
│                                         │
├─────────────────────────────────────────┤
│  🎁 登录奖励预览                        │
│  ✓ AI咨询 5次 → 20次/日                 │
│  ✓ 解锁全部12款日签模板                 │
│  ✓ 历史记录永久云备份                   │
│  ✓ 多设备数据实时同步                   │
└─────────────────────────────────────────┘
```

### 7.3 奖励获得动效

```typescript
// 登录成功后的奖励展示
const RewardAnimation = () => {
  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      className="reward-celebration"
    >
      {/* 礼花特效 */}
      <Confetti />
      
      {/* 奖励卡片逐个展示 */}
      {rewards.map((reward, i) => (
        <motion.div
          key={reward.id}
          initial={{ opacity: 0, y: 50, scale: 0.8 }}
          animate={{ opacity: 1, y: 0, scale: 1 }}
          transition={{ delay: i * 0.2 }}
          className="reward-card"
        >
          <div className="reward-icon">{reward.icon}</div>
          <div className="reward-name">{reward.name}</div>
          <div className="reward-desc">{reward.description}</div>
        </motion.div>
      ))}
      
      {/* CTA按钮 */}
      <motion.button
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
      >
        开始使用
      </motion.button>
    </motion.div>
  );
};
```

---

## 八、实施路线图

### Phase 1: 基础架构（2周）

| 任务 | 优先级 | 负责人 |
|------|--------|--------|
| 本地存储层重构 | P0 | 前端 |
| 用户状态机设计 | P0 | 前端 |
| 登录API开发 | P0 | 后端 |
| 微信登录集成 | P0 | 后端 |

### Phase 2: 功能开放（2周）

| 任务 | 优先级 | 负责人 |
|------|--------|--------|
| 移除所有功能登录限制 | P0 | 前端 |
| 实现次数限制逻辑 | P0 | 前端 |
| 本地数据持久化优化 | P1 | 前端 |
| 游客模式测试 | P0 | QA |

### Phase 3: 同步体系（2周）

| 任务 | 优先级 | 负责人 |
|------|--------|--------|
| 同步管理器开发 | P0 | 前端 |
| 云端存储接口 | P0 | 后端 |
| 数据合并逻辑 | P0 | 前端 |
| 冲突解决UI | P1 | 前端 |

### Phase 4: 激励体系（1周）

| 任务 | 优先级 | 负责人 |
|------|--------|--------|
| 奖励系统开发 | P1 | 后端 |
| 登录引导UI | P1 | 前端 |
| 奖励动效实现 | P2 | 前端 |
| A/B测试配置 | P2 | 产品 |

### Phase 5: 上线优化（1周）

| 任务 | 优先级 | 负责人 |
|------|--------|--------|
| 全链路测试 | P0 | QA |
| 数据迁移验证 | P0 | 后端 |
| 灰度发布 | P0 | 运维 |
| 监控告警 | P1 | 运维 |

---

## 九、关键指标监控

### 9.1 核心指标

| 指标 | 计算方式 | 目标值 |
|------|---------|--------|
| 功能可用率 | 未登录用户完成功能数 / 总功能数 | 100% |
| 登录转化率 | 登录用户数 / 活跃用户数 | 40% |
| 自然登录率 | 主动登录用户 / 总登录用户 | 60% |
| 数据同步成功率 | 成功同步次数 / 总同步次数 | 99.5% |
| 登录流失率 | 开始登录但未完成 / 开始登录总数 | <10% |

### 9.2 数据埋点

```typescript
// 关键事件
{
  'feature_use': {          // 功能使用
    feature: string,
    isLoggedIn: boolean,
    limitReached: boolean
  },
  'login_prompt_show': {    // 登录引导展示
    trigger: string,        // 触发场景
    rewardPreview: string[] // 展示的奖励
  },
  'login_prompt_click': {   // 点击登录引导
    trigger: string,
    ctaType: string
  },
  'login_start': {          // 开始登录
    method: string,         // 登录方式
    source: string          // 来源页面
  },
  'login_success': {        // 登录成功
    method: string,
    rewardsGranted: string[],
    dataMerged: boolean
  },
  'login_fail': {           // 登录失败
    method: string,
    error: string
  },
  'sync_complete': {        // 同步完成
    duration: number,
    recordsSynced: number,
    conflicts: number
  }
}
```

---

## 十、风险评估与应对

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| 数据同步冲突 | 中 | 高 | 智能合并+用户确认 |
| 用户不愿登录 | 高 | 中 | 强化价值感知，非强制 |
| 同步性能问题 | 中 | 中 | 增量同步+本地缓存 |
| 安全漏洞 | 低 | 高 | 加密传输+定期审计 |
| 多设备数据混乱 | 中 | 中 | 设备管理+同步日志 |

---

## 附录

### A. 参考竞品分析

| 产品 | 策略 | 可借鉴 |
|------|------|--------|
| **Notion** | 完全免费，登录云同步 | 功能开放度 |
| **Spotify** | 免费听，登录保存歌单 | 数据驱动登录 |
| **Duolingo** | 免费学，登录保持进度 | 进度保护焦虑 |
| **小宇宙** | 免费听，登录订阅同步 | 自然引导登录 |

### B. 技术选型

| 组件 | 选型 | 理由 |
|------|------|------|
| 本地存储 | localStorage + IndexedDB | 兼容性好 |
| 云端存储 | Vercel KV | 无服务器，易维护 |
| 认证 | Auth.js | 多平台支持 |
| 同步 | 自定义API | 灵活控制 |

---

**文档结束**

*本方案由产品经理与架构师联合设计，如有疑问请联系相关负责人。*
